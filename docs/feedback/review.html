<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DieselSubs â€” Comment Review</title>
  <style>
    :root {
      --maxw: 980px;
      --pad: 16px;
      --gap: 14px;
      --radius: 14px;
      --muted: #6b7280;
      --danger: #b91c1c;
      --ok: #065f46;
      --bg: #f8fafc;
      --card: #ffffff;
      --border: #e5e7eb;
      --focus: #2563eb;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: var(--sans);
      background: var(--bg);
      color: #0f172a;
    }

    .wrap {
      max-width: var(--maxw);
      margin: 24px auto;
      padding: 0 var(--pad);
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 1px 2px rgba(0, 0, 0, .04);
      overflow: hidden;
    }

    .card-hd {
      display: flex;
      align-items: baseline;
      gap: 8px;
      padding: 18px var(--pad);
      border-bottom: 1px solid var(--border);
    }

    .card-hd h1 {
      font-size: 20px;
      margin: 0;
      font-weight: 650;
    }

    .muted {
      color: var(--muted);
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      padding: var(--pad);
    }

    @media (max-width: 800px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    label {
      font-size: 12px;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }

    input[type="text"],
    textarea,
    .pill {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: white;
      font-size: 14px;
      box-sizing: border-box;
    }

    input[readonly] {
      background: #f9fafb;
      color: #111827;
    }

    textarea {
      resize: vertical;
      min-height: 180px;
      line-height: 1.4;
    }

    .row {
      padding: 0 var(--pad) var(--pad);
    }

    .btnbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      padding: 0 var(--pad) var(--pad);
      border-top: 1px solid var(--border);
      background: #fcfcfd;
    }

    button {
      appearance: none;
      border: 1px solid var(--border);
      background: white;
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: box-shadow .15s ease, transform .02s ease;
    }

    button:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    .btn-skip {}

    .btn-delete {
      border-color: #fecaca;
      background: #fff1f2;
      color: var(--danger);
    }

    .btn-delete:focus,
    .btn-delete:hover {
      box-shadow: 0 0 0 3px #fee2e2;
    }

    .btn-skip:focus,
    .btn-skip:hover {
      box-shadow: 0 0 0 3px #dbeafe;
    }

    .btn-ghost {
      background: transparent;
    }

    .status {
      margin-left: auto;
      font-size: 13px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #94a3b8;
      display: inline-block;
    }

    .dot.ok {
      background: #34d399;
    }

    .dot.warn {
      background: #fbbf24;
    }

    .dot.err {
      background: #f87171;
    }

    .kbd {
      font-family: var(--mono);
      font-size: 12px;
      padding: 2px 6px;
      border: 1px solid var(--border);
      border-bottom-width: 2px;
      border-radius: 6px;
      background: #f8fafc;
    }

    .help {
      padding: 8px var(--pad) 16px;
      font-size: 13px;
      color: var(--muted);
    }

    .empty {
      padding: 32px;
      text-align: center;
      color: var(--muted);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" id="panel">
      <div class="card-hd">
        <h1>Comment Review</h1>
        <span class="muted" id="count"></span>
      </div>

      <div class="grid">
        <div>
          <label>Category</label>
          <input id="category" type="text" readonly />
        </div>
        <div>
          <label>Question</label>
          <input id="question" type="text" readonly />
        </div>
        <div>
          <label>Submitter</label>
          <input id="who" type="text" readonly />
        </div>
        <div>
          <label>Received</label>
          <input id="when" type="text" readonly />
        </div>
      </div>

      <div class="row">
        <label>Comment</label>
        <textarea id="comment" placeholder="Loading first commentâ€¦" spellcheck="true"></textarea>
      </div>

      <div class="btnbar">
        <button class="btn-skip" id="btnSkip" title="Skip (S)"><span>Skip</span></button>
        <button class="btn-delete" id="btnDelete" title="Delete (D)"><span>Delete</span></button>
        <div class="status" id="status"><span class="dot" id="dot"></span><span id="statustxt">Idle</span></div>
      </div>
      <div class="help">Hotkeys: <span class="kbd">S</span> = Skip, <span class="kbd">D</span> = Delete</div>
    </div>
    <div id="empty" class="empty" hidden>No more comments to review. ðŸŽ‰</div>
  </div>

  <script>
    (function () {
      // ==== CONFIGURE THESE TO MATCH YOUR BACKEND ====
      const API_BASE = 'https://dieselsubs.com/api';
      // Returns the next comment to review.
      // Response shape (example): { id: 123, category: 'Hull and Compartments', question: 'What is a hatch?', comment: '...', submitter_name: 'Jane', submitter_email: 'jane@example.com', created_at: '2025-10-20T21:15:00Z', total_remaining: 42 }
      const ENDPOINT_NEXT = API_BASE + '/admin.php?action=next';
      // Deletes a specific comment id. Accepts POST JSON { id } and returns { ok: true }

      // Optional bearer token support (simple admin gate). If you store a token in
      // localStorage.setItem('ds_admin_token', 'YOURTOKEN'), it will be sent as Authorization header.
      function authHeaders() {
        const h = {};
        const t = localStorage.getItem('ds_admin_token');
        if (t) h['Authorization'] = 'Bearer ' + t;
        return h;
      }

      // ====== Elements ======
      const el = {
        card: document.getElementById('panel'),
        empty: document.getElementById('empty'),
        category: document.getElementById('category'),
        question: document.getElementById('question'),
        who: document.getElementById('who'),
        when: document.getElementById('when'),
        comment: document.getElementById('comment'),
        btnSkip: document.getElementById('btnSkip'),
        btnDelete: document.getElementById('btnDelete'),
        status: document.getElementById('status'),
        dot: document.getElementById('dot'),
        statustxt: document.getElementById('statustxt'),
        count: document.getElementById('count'),
      };

      let current = null; // currently loaded comment record

      function setBusy(msg) {
        el.btnSkip.disabled = true;
        el.btnDelete.disabled = true;
        el.dot.className = 'dot warn';
        el.statustxt.textContent = msg || 'Workingâ€¦';
      }
      function setIdle(msg) {
        el.btnSkip.disabled = false;
        el.btnDelete.disabled = false;
        el.dot.className = 'dot ok';
        el.statustxt.textContent = msg || 'Ready';
      }
      function setError(msg) {
        el.btnSkip.disabled = false;
        el.btnDelete.disabled = false;
        el.dot.className = 'dot err';
        el.statustxt.textContent = msg || 'Error';
      }

      async function apiNext() {
        const ctl = new AbortController();
        const t = setTimeout(() => ctl.abort(), 15000);
        try {
          setBusy('Loading nextâ€¦');
          const res = await fetch(ENDPOINT_NEXT, { headers: { 'Accept': 'application/json', ...authHeaders() }, signal: ctl.signal });
          clearTimeout(t);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          return data;
        } catch (e) {
          setError('Failed to load: ' + e.message);
          throw e;
        }
      }

      async function apiDelete(id) {
        const ctl = new AbortController();
        const t = setTimeout(() => ctl.abort(), 15000);
        try {
          setBusy('Deletingâ€¦');
          const res = await fetch(ENDPOINT_DELETE, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', ...authHeaders() },
            body: JSON.stringify({ id }),
            signal: ctl.signal,
          });
          clearTimeout(t);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          if (!data || data.ok !== true) throw new Error('Delete failed');
          return true;
        } catch (e) {
          setError('Delete failed: ' + e.message);
          throw e;
        }
      }

      function render(record) {
        if (!record) return;
        current = record;
        el.category.value = record.category || '';
        el.question.value = record.question || '';
        const who = [record.submitter_name, record.submitter_email].filter(Boolean).join(' Â· ');
        el.who.value = who || 'â€”';
        el.when.value = record.created_at ? new Date(record.created_at).toLocaleString() : 'â€”';
        // Do not truncate the comment â€” insert as-is
        el.comment.value = record.comment || '';
        el.comment.scrollTop = 0;
        el.count.textContent = typeof record.total_remaining === 'number' ? `Remaining: ${record.total_remaining}` : '';
        setIdle('Loaded');
      }

      function showEmpty() {
        el.card.hidden = true;
        el.empty.hidden = false;
        el.count.textContent = '';
        el.dot.className = 'dot';
        el.statustxt.textContent = 'All caught up';
      }

      async function loadNext() {
        try {
          const rec = await apiNext();
          if (!rec || !rec.id) return showEmpty();
          render(rec);
        } catch (e) {
          // already set by apiNext
        }
      }

      async function onSkip() {
        // Simply fetch the next one without any changes
        await loadNext();
      }

      async function onDelete() {
        if (!current || !current.id) return;
        const ok = confirm('Delete this comment permanently? This cannot be undone.');
        if (!ok) return;
        try {
          await apiDelete(current.id);
          await loadNext();
        } catch (e) {
          // status set in apiDelete
        }
      }

      // Wire up
      el.btnSkip.addEventListener('click', onSkip);
      el.btnDelete.addEventListener('click', onDelete);

      // Hotkeys: S = skip, D = delete (ignore when typing in textarea)
      document.addEventListener('keydown', (ev) => {
        const tag = (ev.target && ev.target.tagName) ? ev.target.tagName.toLowerCase() : '';
        const inTyping = tag === 'textarea' || tag === 'input';
        if (inTyping) return;
        if (ev.key === 's' || ev.key === 'S') { ev.preventDefault(); onSkip(); }
        if (ev.key === 'd' || ev.key === 'D') { ev.preventDefault(); onDelete(); }
      });

      // Kick things off on load
      loadNext();
    })();
  </script>
  <form id="reviewForm">
    <input type="text" name="name" placeholder="Your name" required>
    <input type="email" name="email" placeholder="Your email" required>
    <textarea name="comment" placeholder="Your review" required></textarea>
    <button type="submit">Send</button>
  </form>

  <script>
    document.getElementById('reviewForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const response = await fetch('https://dieselsubs.com/api/sendmail.php', {
        method: 'POST',
        body: formData
      });
      const result = await response.json();
      alert(result.success ? 'Email sent!' : 'Failed: ' + result.error);
    });
  </script>

</body>

</html>