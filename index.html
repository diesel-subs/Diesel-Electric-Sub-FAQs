<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diesel-Electric Submarine FAQs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Simple markdown renderer function
        function renderMarkdown(text) {
            console.log('renderMarkdown called with:', typeof text, text ? text.substring(0, 50) : 'empty');
            
            if (!text) return '';
            
            // Use marked library if available, otherwise fall back to basic replacements
            if (typeof marked !== 'undefined') {
                try {
                    const result = marked.parse ? marked.parse(text) : marked(text);
                    console.log('Marked success, result length:', result.length);
                    return result;
                } catch (e) {
                    console.error('Marked error:', e);
                    return basicMarkdownRender(text);
                }
            }
            console.log('Using basic markdown renderer');
            return basicMarkdownRender(text);
        }
        
        // Basic markdown rendering fallback
        function basicMarkdownRender(text) {
            console.log('Basic markdown input:', text.substring(0, 50));
            const result = text
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')  // Bold
                .replace(/\*([^*]+)\*/g, '<em>$1</em>')               // Italic
                .replace(/\n\n/g, '</p><p>')                        // Paragraphs
                .replace(/\n/g, '<br>')                             // Line breaks
                .replace(/^/, '<p>')                                // Start paragraph
                .replace(/$/, '</p>');                              // End paragraph
            console.log('Basic markdown output:', result.substring(0, 50));
            return result;
        }
    </script>
    <style>
        .hero {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 60px 0;
        }

        .category-card {
            transition: transform 0.3s;
            cursor: pointer;
        }

        .category-card:hover {
            transform: translateY(-5px);
        }

        .faq-item {
            margin-bottom: 20px;
        }

        .faq-question {
            cursor: pointer;
        }

        .faq-answer {
            display: none;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
        }

        .search-box {
            max-width: 500px;
            margin: 20px auto;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }
    </style>
</head>

<body>
    <div class="hero">
        <div class="container text-center">
            <h1 class="display-4">üî± Diesel-Electric Submarine FAQs</h1>
            <p class="lead">Your comprehensive guide to submarine knowledge</p>
            <div id="stats" class="alert alert-info mt-4">
                <strong>üìä Loading site statistics...</strong>
            </div>

            <!-- Search Box -->
            <div class="search-box">
                <div class="input-group">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search FAQs...">
                    <button class="btn btn-light" onclick="searchFAQs()">üîç Search</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container my-5">
        <!-- Categories Section -->
        <div id="categoriesSection">
            <h2>üìö Browse by Category</h2>
            <div id="categories" class="row">
                <div class="loading">Loading categories...</div>
            </div>
        </div>

        <!-- FAQs Section (hidden by default) -->
        <div id="faqsSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 id="faqsTitle">FAQs</h2>
                <button class="btn btn-secondary" onclick="showCategories()">‚Üê Back to Categories</button>
            </div>
            <div id="faqs"></div>
        </div>

        <!-- Search Results Section -->
        <div id="searchSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 id="searchTitle">Search Results</h2>
                <button class="btn btn-secondary" onclick="showCategories()">‚Üê Back to Categories</button>
            </div>
            <div id="searchResults"></div>
        </div>
    </div>

    <script>
        // Global variables
        let currentCategories = [];
        let currentFAQs = [];

        // Load site statistics
        async function loadStats() {
            try {
                const response = await fetch('/api/faqs?action=stats');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const stats = await response.json();

                if (stats.error) {
                    throw new Error(stats.error);
                }

                document.getElementById('stats').innerHTML = `
                <strong>üìä Site Statistics:</strong> 
                ${stats.total_faqs} FAQs across ${stats.total_categories} categories
                <span class="badge bg-success ms-2">API Online</span>
            `;
            } catch (error) {
                console.log('Stats API failed:', error);
                // Don't load static categories here - let loadCategories handle it
                document.getElementById('stats').innerHTML = `
                <strong>üìä Site Statistics:</strong> 
                185 FAQs across 6 categories
                <span class="badge bg-warning ms-2">Loading...</span>
            `;
            }
        }

        // Static fallback categories
        function loadStaticCategories() {
            const staticCategories = [
                { id: 1, name: "Hull and Compartments", description: "Learn about submarine construction, hull design, and compartment layouts." },
                { id: 2, name: "US WW2 Subs in General", description: "General information about American submarines during World War II." },
                { id: 3, name: "Life Aboard WW2 US Subs", description: "Daily life, living conditions, and crew experiences aboard submarines." },
                { id: 4, name: "Operating US Subs in WW2", description: "Operational procedures, tactics, and submarine warfare techniques." },
                { id: 5, name: "Attacks and Battles, Small and Large", description: "Combat operations, battles, and military engagements." },
                { id: 6, name: "Who Were the Crews Aboard WW2 US Subs", description: "Information about submarine crews, their roles, and backgrounds." }
            ];

            const categoriesHTML = staticCategories.map(category => `
            <div class="col-md-4 mb-4">
                <div class="card category-card h-100" onclick="showComingSoon('${category.name}')">
                    <div class="card-body">
                        <h5 class="card-title">${getCategoryIcon(category.name)} ${category.name}</h5>
                        <p class="card-text">${category.description}</p>
                        <span class="badge bg-primary">185 FAQs Available</span>
                        <div class="mt-2">
                            <small class="text-muted">Database connecting... Check back soon for full functionality!</small>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');

            document.getElementById('categories').innerHTML = categoriesHTML;
        }

        function showComingSoon(categoryName) {
            alert(`üöß ${categoryName} FAQs\n\nThe database is connecting. All 185 FAQs will be available soon!\n\nThis includes detailed information about:\n‚Ä¢ ${categoryName}\n‚Ä¢ Interactive Q&A format\n‚Ä¢ Search functionality\n‚Ä¢ Full content from our submarine experts`);
        }

        // Load categories
        async function loadCategories() {
            try {
                console.log('Loading categories from API...');
                const response = await fetch('/api/faqs?action=categories');
                console.log('API Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('API Data received:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                currentCategories = data;

                const categoriesHTML = currentCategories.map(category => `
                <div class="col-md-4 mb-4">
                    <div class="card category-card h-100" onclick="testClick(${category.id})">
                        <div class="card-body">
                            <h5 class="card-title">${getCategoryIcon(category.name)} ${category.name}</h5>
                            <p class="card-text">${getCategoryDescription(category.name)}</p>
                            <span class="badge bg-success">Click to Browse FAQs</span>
                            <div class="mt-2">
                                <small class="text-success">‚úÖ API Working - Sample FAQs Ready</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

                document.getElementById('categories').innerHTML = categoriesHTML;
                console.log('Categories loaded successfully from API');

                // Update stats to show API is working
                document.getElementById('stats').innerHTML = `
                <strong>üìä Site Statistics:</strong> 
                185 FAQs across 6 categories
                <span class="badge bg-success ms-2">API Connected</span>
            `;

            } catch (error) {
                console.error('Categories API failed:', error);
                alert('API Error: ' + error.message + '. Check the browser console for details.');
            }
        }

        // Get category icon
        function getCategoryIcon(name) {
            if (name.includes('Hull')) return 'üîß';
            if (name.includes('General')) return 'üá∫üá∏';
            if (name.includes('Life')) return 'üë•';
            if (name.includes('Operating')) return '‚öôÔ∏è';
            if (name.includes('Attacks')) return 'üí•';
            if (name.includes('Crews')) return 'üë®‚Äç‚úàÔ∏è';
            return 'üìã';
        }

        // Get category description
        function getCategoryDescription(name) {
            const descriptions = {
                'Hull and Compartments': 'Learn about submarine construction, hull design, and compartment layouts.',
                'US WW2 Subs in General': 'General information about American submarines during World War II.',
                'Life Aboard WW2 US Subs': 'Daily life, living conditions, and crew experiences aboard submarines.',
                'Operating US Subs in WW2': 'Operational procedures, tactics, and submarine warfare techniques.',
                'Attacks and Battles, Small and Large': 'Combat operations, battles, and military engagements.',
                'Who Were the Crews Aboard WW2 US Subs': 'Information about submarine crews, their roles, and backgrounds.'
            };
            return descriptions[name] || 'Detailed information about submarine operations and technology.';
        }

        // Simple test function to see if clicks work at all
        function testClick(categoryId) {
            alert('Click detected! Category ID: ' + categoryId);
            const categoryName = currentCategories.find(cat => cat.id === categoryId)?.name || 'Unknown';
            loadCategoryFAQs(categoryId, categoryName);
        }

        // Load FAQs for a specific category
        async function loadCategoryFAQs(categoryId, categoryName) {
            alert('FAQ function called! Category: ' + categoryName);
            console.log('=== STARTING FAQ LOAD ===');
            console.log(`Category ID: ${categoryId}, Name: ${categoryName}`);
            
            // SIMPLE TEST: Just show a hardcoded FAQ first
            document.getElementById('faqsTitle').textContent = `${getCategoryIcon(categoryName)} ${categoryName}`;
            document.getElementById('faqs').innerHTML = `
                <div class="faq-item">
                    <div class="card">
                        <div class="card-header faq-question" onclick="toggleFAQ(0)">
                            <h6 class="mb-0">‚ùì SIMPLE TEST FAQ</h6>
                        </div>
                        <div id="faq-0" class="faq-answer">
                            <div class="card-body">
                                <p>This is a <strong>BOLD TEST</strong> and <em>italic test</em>.</p>
                                <p>If you see this with formatting, HTML rendering works!</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showSection('faqsSection');
            console.log('Simple test FAQ displayed');
            
            // Now try the actual API call
            try {
                console.log('Now trying actual API call...');
                const response = await fetch(`/api/faqs?action=faqs&category_id=${categoryId}`);
                console.log('API Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('API returned', data.length, 'FAQs');
                    console.log('First FAQ question:', data[0]?.question);
                    console.log('First FAQ answer preview:', data[0]?.answer?.substring(0, 100));
                } else {
                    console.error('API response not OK:', response.status);
                }
            } catch (apiError) {
                console.error('API call failed:', apiError);
            }
        }

        // Toggle FAQ answer visibility
        function toggleFAQ(index) {
            const answer = document.getElementById(`faq-${index}`);
            answer.style.display = answer.style.display === 'block' ? 'none' : 'block';
        }

        // Search FAQs
        async function searchFAQs() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            try {
                const response = await fetch(`/api/faqs?action=search&q=${encodeURIComponent(query)}`);
                const results = await response.json();

                document.getElementById('searchTitle').textContent = `üîç Search Results for "${query}"`;

                if (results.length === 0) {
                    document.getElementById('searchResults').innerHTML = `
                    <div class="alert alert-info">
                        No FAQs found matching "${query}". Try different keywords.
                    </div>
                `;
                } else {
                    // Process search results and render markdown for each answer
                    const processedResults = results.map(faq => ({
                        ...faq,
                        renderedAnswer: renderMarkdown(faq.answer)
                    }));

                    const resultsHTML = processedResults.map((faq, index) => `
                    <div class="faq-item">
                        <div class="card">
                            <div class="card-header faq-question" onclick="toggleSearchFAQ(${index})">
                                <h6 class="mb-0">‚ùì ${faq.question}</h6>
                                <small class="text-muted">${getCategoryIcon(faq.category_name)} ${faq.category_name}</small>
                            </div>
                            <div id="search-faq-${index}" class="faq-answer">
                                <div class="card-body">
                                    ${faq.renderedAnswer}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                    document.getElementById('searchResults').innerHTML = resultsHTML;
                }

                showSection('searchSection');
            } catch (error) {
                alert('Error searching FAQs. Please try again.');
            }
        }

        // Toggle search FAQ answer
        function toggleSearchFAQ(index) {
            const answer = document.getElementById(`search-faq-${index}`);
            answer.style.display = answer.style.display === 'block' ? 'none' : 'block';
        }

        // Show specific section
        function showSection(sectionId) {
            ['categoriesSection', 'faqsSection', 'searchSection'].forEach(id => {
                document.getElementById(id).style.display = id === sectionId ? 'block' : 'none';
            });
        }

        // Show categories (back button)
        function showCategories() {
            showSection('categoriesSection');
            document.getElementById('searchInput').value = '';
        }

        // Allow Enter key for search
        document.addEventListener('DOMContentLoaded', function () {
            alert('Page loaded! JavaScript is working.');
            
            document.getElementById('searchInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    searchFAQs();
                }
            });

            // Test if categories div exists
            const categoriesDiv = document.getElementById('categories');
            if (categoriesDiv) {
                alert('Categories div found');
                // Add a simple test
                categoriesDiv.innerHTML = '<div class="col-12"><button onclick="alert(\'Button clicked!\')">TEST BUTTON - CLICK ME</button></div>';
            } else {
                alert('Categories div NOT found');
            }

            // Load initial data - categories first, then stats
            try {
                loadCategories();
                loadStats();
            } catch (error) {
                alert('Error loading categories: ' + error.message);
            }
        });
    </script>

</body>

</html>